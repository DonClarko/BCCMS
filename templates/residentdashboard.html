<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay Complaint Management System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/residentdashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"></script>
    <script src="{{ url_for('static', filename='js/firebaseConfig.js') }}"></script>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">BCCMS</div>
                <ul class="menu">
                    <li><a href="#home">Home</a></li>
                    <li><a href="#my-complaints">My Complaints</a></li>
                    <li><a href="#messages">Messages</a></li>
                    <li><a href="#notifications">Notifications</a></li>
                    <li class="user-menu">
                        <a href="#profile"><i class="fas fa-user-circle"></i> Profile</a>
                        <div class="dropdown-content">
                            <a href="#profile"><i class="fas fa-user"></i> My Profile</a>
                            <a href="#feedback"><i class="fas fa-comment-alt"></i> Provide Feedback</a>
                            <a href="{{ url_for('auth.show_auth', form_type='login') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </li>
                </ul>
                <div class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <a href="#home">Home</a>
        <a href="#my-complaints">My Complaints</a>
        <a href="#messages">Messages</a>
        <a href="#notifications">Notifications</a>
        <a href="#profile">Profile</a>
        <a href="#feedback">Feedback</a>
        <a href="{{ url_for('auth.show_auth', form_type='login') }}">Logout</a>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Welcome Section -->
        <section id="home" class="welcome-section">
            <div class="welcome-content">
                <h1>Welcome to Barangay Complaint System</h1>
                <p>Submit and track your community concerns in one place</p>
                <a href="#" id="submit-complaint-btn" class="btn-primary">
                    <i class="fas fa-plus-circle"></i> Submit New Complaint
                </a>
            </div>
<!-- Updated Quick Stats Section -->
<div class="quick-stats">
    <div class="stat-card">
        <h3>Open Cases</h3>
        <p class="stat-number">0</p>
        <p class="stat-urgent"><i class="fas fa-exclamation-triangle"></i> <span class="urgent-count">0</span> urgent</p>
    </div>
    <div class="stat-card">
        <h3>Resolved</h3>
        <p class="stat-number">0</p>
        <p class="stat-change"><i class="fas fa-arrow-up"></i> <span class="resolved-change">0</span>% from last month</p>
    </div>
    <div class="stat-card">
        <h3>Avg. Resolution</h3>
        <p class="stat-number">0 days</p>
        <p class="stat-change"><i class="fas fa-arrow-down"></i> <span class="resolution-change">0</span> days improvement</p>
    </div>
</div>
        </section>

        <!-- Recent Complaints Section -->
        <section id="my-complaints" class="complaints-section">
            <div class="section-header">
                <h2>Your Recent Complaints</h2>
                <a href="#all-complaints" class="btn-link">View All</a>
            </div>
            <div class="complaints-grid" id="recent-complaints-container">
                <!-- Complaints will be loaded here dynamically -->
                <p class="loading">Loading your complaints...</p>
            </div>
        </section>

        <!-- Feedback Section (Modal Trigger) -->
        <section id="feedback" class="feedback-section">
            <div class="feedback-cta">
                <h2>We Value Your Feedback</h2>
                <p>Help us improve our services by sharing your experience</p>
                <button id="give-feedback-btn" class="btn-primary">
                    <i class="fas fa-comment-alt"></i> Provide Feedback
                </button>
            </div>
        </section>
    </main>

    <!-- Complaint Form Modal -->
    <div id="complaint-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Submit New Complaint</h2>
            
            <form id="complaint-form" class="step-form">
                <!-- Step 1: Basic Information -->
                <div class="form-step active" data-step="1">
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category" required>
                            <option value="">Select a category</option>
                            <option value="noise">Noise Disturbance</option>
                            <option value="waste">Waste Management</option>
                            <option value="road">Road Repair</option>
                            <option value="water">Water Supply Issue</option>
                            <option value="security">Safety Concern</option>
                            <option value="others">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="title">Complaint Title</label>
                        <input type="text" id="title" name="title" placeholder="Brief description of the issue" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Detailed Description</label>
                        <textarea id="description" name="description" placeholder="Describe the issue in detail..." required></textarea>
                    </div>
                    
                    <div class="form-group-row">
                        <div class="form-group">
                            <label for="incident-date">Date of Incident</label>
                            <input type="date" id="incident-date" name="incident-date">
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" placeholder="Where did it happen?" required>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-next" data-next="2">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Step 2: Additional Details -->
                <div class="form-step" data-step="2">
                    <div class="form-group">
                        <label>Would you like to provide your contact information for follow-up?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="contact-preference" value="yes" checked> Yes</label>
                            <label><input type="radio" name="contact-preference" value="no"> No (Submit anonymously)</label>
                        </div>
                    </div>
                    
                    <div id="contact-fields">
                        <div class="form-group">
                            <label for="full-name">Your Name</label>
                            <input type="text" id="full-name" name="full-name" placeholder="Your full name">
                        </div>
                        
                        <div class="form-group-row">
                            <div class="form-group">
                                <label for="contact-number">Phone Number</label>
                                <input type="tel" id="contact-number" name="contact-number" placeholder="Your contact number">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="Your email address">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="attachment">Upload Evidence (Optional)</label>
                        <input type="file" id="attachment" name="attachment" multiple>
                        <p class="form-hint">You can upload photos, videos, or documents related to your complaint</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-prev" data-prev="1"><i class="fas fa-arrow-left"></i> Back</button>
                        <button type="submit" class="btn-submit"><i class="fas fa-paper-plane"></i> Submit Complaint</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Feedback Form Modal -->
    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Provide Feedback</h2>
            
            <form id="feedback-form">
                <div class="form-group">
                    <label>What would you like to provide feedback about?</label>
                    <select id="feedback-type" name="feedback-type" required>
                        <option value="">Select feedback type</option>
                        <option value="complaint-process">Complaint Process</option>
                        <option value="response-time">Response Time</option>
                        <option value="staff-courtesy">Staff Courtesy</option>
                        <option value="resolution-quality">Resolution Quality</option>
                        <option value="system-usability">System Usability</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="feedback-rating">Rating</label>
                    <div class="rating-stars">
                        <input type="radio" id="star5" name="rating" value="5">
                        <label for="star5"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star4" name="rating" value="4">
                        <label for="star4"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star3" name="rating" value="3">
                        <label for="star3"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star2" name="rating" value="2">
                        <label for="star2"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star1" name="rating" value="1">
                        <label for="star1"><i class="fas fa-star"></i></label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="feedback-message">Your Feedback</label>
                    <textarea id="feedback-message" name="feedback-message" placeholder="Please share your experience..." required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Compose Message Modal -->
    <div id="compose-message-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2><i class="fas fa-pen-fancy"></i> Send Message to Official</h2>
            
            <form id="compose-message-form" class="compose-message-form">
                <div class="form-group">
                    <label for="message-recipient">Select Official</label>
                    <select id="message-recipient" name="recipient" required>
                        <option value="">-- Choose an official --</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="message-complaint">Related Complaint (Optional)</label>
                    <select id="message-complaint" name="complaint_id">
                        <option value="">-- Select complaint --</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="message-subject">Subject</label>
                    <input type="text" id="message-subject" name="subject" placeholder="Message subject..." required>
                </div>

                <div class="form-group">
                    <label for="message-content">Message</label>
                    <textarea id="message-content" name="content" placeholder="Type your message here..." required></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn">&times;</span>
            <h2><i class="fas fa-envelope"></i> Messages</h2>
            <button id="compose-message-btn" class="btn-primary" style="margin-bottom: 15px; padding: 6px 12px; font-size: 14px;">
                <i class="fas fa-plus"></i> Compose
            </button>
            <div class="messages-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Messages will be loaded here dynamically by messaging.js -->
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn">&times;</span>
            <h2><i class="fas fa-bell"></i> Notifications</h2>
            <div class="notifications-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Notifications will be loaded here dynamically by messaging.js -->
            </div>
        </div>
    </div>

    <!-- Complaint Details Modal -->
<div id="complaint-details-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div id="complaint-details-content">
            <!-- Content will be loaded here dynamically -->
        </div>
    </div>
</div>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h3>Need Help?</h3>
                <p><i class="fas fa-clock"></i> Monday-Friday, 8:00 AM - 5:00 PM</p>
                <p><i class="fas fa-phone"></i> +63 123 456 7890</p>
                <p><i class="fas fa-envelope"></i> support@bccms.com</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#" id="footer-submit-btn"><i class="fas fa-plus-circle"></i> Submit Complaint</a></li>
                    <li><a href="#messages"><i class="fas fa-envelope"></i> Messages</a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                    <li><a href="#feedback"><i class="fas fa-comment-alt"></i> Feedback</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>About BCCMS</h3>
                <p>A digital platform for efficient complaint management in the barangay.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Barangay Complaint Management System. All rights reserved.</p>
        </div>
    </footer>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    function loadStats() {
    fetch('/resident/stats')
        .then(response => response.json())
        .then(data => {
            // Update Open Cases
            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = data.open_cases;
            document.querySelector('.stat-card:nth-child(1) .urgent-count').textContent = data.urgent_open;

            // Update Resolved
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = data.resolved;
            
            // Update Avg. Resolution
            const avgResElement = document.querySelector('.stat-card:nth-child(3) .stat-number');
            avgResElement.textContent = `${data.avg_resolution} days`;
        })
        .catch(error => console.error('Error loading stats:', error));
}
    loadStats();
    // Modal control
    const complaintModal = document.getElementById("complaint-modal");
    const feedbackModal = document.getElementById("feedback-modal");
    const complaintDetailsModal = document.getElementById("complaint-details-modal");
    const openComplaintButtons = [
        document.getElementById("submit-complaint-btn"),
        document.getElementById("footer-submit-btn")
    ];
    const openFeedbackButton = document.getElementById("give-feedback-btn");
    const closeButtons = document.querySelectorAll(".close-btn");
    const viewAllButton = document.querySelector('a[href="#all-complaints"]');
    
    // Add logout functionality
    const logoutLinks = document.querySelectorAll('a[href*="login"]');
    logoutLinks.forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/auth/logout');
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/auth/login';
            }
        });
    });
    
    function openModal(modal) {
        const elem = typeof modal === 'string' ? document.getElementById(modal) : modal;
        if (elem) {
            elem.style.display = "block";
            document.body.style.overflow = "hidden";
        }
    }
    
    function closeModal(modal) {
        const elem = typeof modal === 'string' ? document.getElementById(modal) : modal;
        if (elem) {
            elem.style.display = "none";
            document.body.style.overflow = "auto";
        }
        if (elem === complaintModal) resetComplaintForm();
    }
    
    openComplaintButtons.forEach(btn => {
        if (btn) btn.addEventListener("click", (e) => {
            e.preventDefault();
            openModal(complaintModal);
        });
    });
    
    if (openFeedbackButton) {
        openFeedbackButton.addEventListener("click", (e) => {
            e.preventDefault();
            openModal(feedbackModal);
        });
    }
    
    closeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const modal = btn.closest(".modal");
            closeModal(modal);
        });
    });
    
    window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
            closeModal(e.target);
        }
    });
    
    // Handle "Give Feedback" button clicks in complaint cards
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-feedback')) {
            e.preventDefault();
            openModal(feedbackModal);
        }
    });
    
    // Mobile menu toggle
    const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");
    const mobileMenu = document.querySelector(".mobile-menu");
    
    if (mobileMenuToggle && mobileMenu) {
        mobileMenuToggle.addEventListener("click", () => {
            mobileMenu.style.display = mobileMenu.style.display === "block" ? "none" : "block";
        });
    }
    
    // Form step navigation
    const formSteps = document.querySelectorAll(".form-step");
    const nextButtons = document.querySelectorAll(".btn-next");
    const prevButtons = document.querySelectorAll(".btn-prev");
    
    nextButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const currentStep = btn.closest(".form-step");
            const nextStep = document.querySelector(`.form-step[data-step="${btn.dataset.next}"]`);
            
            currentStep.classList.remove("active");
            nextStep.classList.add("active");
        });
    });
    
    prevButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const currentStep = btn.closest(".form-step");
            const prevStep = document.querySelector(`.form-step[data-step="${btn.dataset.prev}"]`);
            
            currentStep.classList.remove("active");
            prevStep.classList.add("active");
        });
    });
    
    // Contact preference toggle
    const contactPreference = document.querySelectorAll("input[name='contact-preference']");
    const contactFields = document.getElementById("contact-fields");
    
    contactPreference.forEach(radio => {
        radio.addEventListener("change", () => {
            contactFields.style.display = radio.value === "yes" ? "block" : "none";
        });
    });
    
    // Form submission
    const complaintForm = document.getElementById("complaint-form");
    if (complaintForm) {
        complaintForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                
                const response = await fetch('/complaint/submit', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'  // Include session cookies
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Complaint submitted successfully! Your complaint ID: ${result.complaint_id}`);
                    closeModal(complaintModal);
                    loadRecentComplaints(); // Refresh the complaints list
                } else {
                    alert(`Error: ${result.message || 'Failed to submit complaint'}`);
                }
            } catch (error) {
                console.error('Error submitting complaint:', error);
                alert("There was an error submitting your complaint. Please try again.");
            }
        });
    }
    
    const feedbackForm = document.getElementById("feedback-form");
    if (feedbackForm) {
        feedbackForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                
                const response = await fetch('/feedback/submit', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Thank you for your valuable feedback!');
                    feedbackForm.reset();
                    closeModal(feedbackModal);
                } else {
                    alert(`Error: ${result.message || 'Failed to submit feedback'}`);
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('There was an error submitting your feedback. Please try again.');
            }
        });
    }
    
    // Mark as read buttons
    const markReadButtons = document.querySelectorAll(".btn-mark-read");
    markReadButtons.forEach(btn => {
        btn.addEventListener("click", function() {
            const card = this.closest(".message-card, .notification-card");
            if (card) {
                card.classList.remove("unread");
                updateNotificationCounts();
            }
        });
    });
    
    function resetComplaintForm() {
        // Reset form steps
        formSteps.forEach(step => step.classList.remove("active"));
        document.querySelector(".form-step[data-step='1']").classList.add("active");
        
        // Reset form fields
        if (complaintForm) complaintForm.reset();
    }
    
    function updateNotificationCounts() {
        // This would be more dynamic in a real application
        const unreadMessages = document.querySelectorAll(".message-card.unread").length;
        const unreadNotifications = document.querySelectorAll(".notification-card.unread").length;
        
        document.querySelectorAll(".notification-count").forEach(el => {
            if (el.closest("#messages")) {
                el.textContent = unreadMessages;
            } else if (el.closest("#notifications")) {
                el.textContent = unreadNotifications;
            }
        });
    }
    
    // Initialize
    updateNotificationCounts();
    loadRecentComplaints();
    
    // View Details and View All functionality
    document.addEventListener('click', function(e) {
        // Handle View Details click
        if (e.target.closest('.btn-view')) {
            e.preventDefault();
            const complaintCard = e.target.closest('.complaint-card');
            const complaintId = complaintCard.querySelector('.complaint-id').textContent;
            showComplaintDetails(complaintId);
        }
        
        // Handle View All click
        if (e.target === viewAllButton || e.target.closest('a[href="#all-complaints"]')) {
            e.preventDefault();
            showAllComplaints();
        }
    });
});

// Load and display recent complaints
// Load and display recent complaints
async function loadRecentComplaints() {
    try {
        const response = await fetch('/complaint/recent', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'  // Include session cookies
        });
        
        // Check if response redirects to login (session expired)
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        
        const complaints = await response.json();
        
        const complaintsGrid = document.querySelector('#recent-complaints-container');
        if (!complaintsGrid) return;
        
        complaintsGrid.innerHTML = ''; // Clear existing cards
        
        if (complaints.length === 0) {
            complaintsGrid.innerHTML = '<p class="no-complaints">No complaints submitted yet.</p>';
            return;
        }
        
        // Limit to displaying only 3 complaints
        const complaintsToShow = complaints.slice(0, 3);
        
        complaintsToShow.forEach(complaint => {
            const complaintDate = new Date(complaint.submitted_date);
            const formattedDate = complaintDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const statusClass = getStatusClass(complaint.status);
            
            const complaintCard = document.createElement('div');
            complaintCard.className = 'complaint-card';
            complaintCard.innerHTML = `
                <div class="complaint-header">
                    <span class="complaint-id">${complaint.id}</span>
                    <span class="status-badge ${statusClass}">${complaint.status}</span>
                </div>
                <h3 class="complaint-title">${complaint.title}</h3>
                <p class="complaint-date"><i class="far fa-calendar-alt"></i> Submitted: ${formattedDate}</p>
                <p class="complaint-location"><i class="fas fa-map-marker-alt"></i> ${complaint.location}</p>
                <div class="complaint-actions">
                    <a href="#view" class="btn-view"><i class="fas fa-eye"></i> View Details</a>
                    ${complaint.status === 'Resolved' ? 
                        '<a href="#feedback" class="btn-feedback"><i class="fas fa-comment-alt"></i> Give Feedback</a>' : 
                        '<a href="#message" class="btn-message"><i class="fas fa-envelope"></i> Message</a>'}
                </div>
            `;
            
            complaintsGrid.appendChild(complaintCard);
        });
        
        // If there are more complaints than shown, make sure the "View All" link is visible
        const viewAllLink = document.querySelector('a[href="#all-complaints"]');
        if (viewAllLink && complaints.length > 3) {
            viewAllLink.style.display = 'inline-block';
        }
    } catch (error) {
        console.error('Error loading complaints:', error);
        // If there's an authentication error, redirect to login
        if (error.status === 401) {
            window.location.href = '/auth/login';
        }
    }
}

// Show details for a single complaint
async function showComplaintDetails(complaintId) {
    try {
        const response = await fetch(`/complaint/details?id=${complaintId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'  // Include session cookies
        });
        
        // Check if response redirects to login (session expired)
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        
        const complaint = await response.json();
        
        if (complaint.error) {
            alert(complaint.error);
            return;
        }
        
        const complaintDate = new Date(complaint.submitted_date);
        const formattedDate = complaintDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const incidentDate = complaint.incident_date ? new Date(complaint.incident_date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }) : 'Not specified';
        
        const statusClass = getStatusClass(complaint.status);
        
        const detailsContent = document.getElementById('complaint-details-content');
        detailsContent.innerHTML = `
            <h2>Complaint Details</h2>
            <div class="complaint-details-card">
                <div class="complaint-header">
                    <span class="complaint-id">${complaint.id}</span>
                    <span class="status-badge ${statusClass}">${complaint.status}</span>
                </div>
                
                <div class="detail-row">
                    <h3 class="complaint-title">${complaint.title}</h3>
                </div>
                
                <div class="detail-row">
                    <p><strong>Category:</strong> ${complaint.category}</p>
                </div>
                
                <div class="detail-row">
                    <p><strong>Submitted:</strong> ${formattedDate}</p>
                </div>
                
                <div class="detail-row">
                    <p><strong>Incident Date:</strong> ${incidentDate}</p>
                </div>
                
                <div class="detail-row">
                    <p><strong>Location:</strong> ${complaint.location}</p>
                </div>
                
                <div class="detail-row">
                    <h4>Description</h4>
                    <p>${complaint.description}</p>
                </div>
                
                ${complaint.attachments?.length ? `
                <div class="detail-row">
                    <h4>Uploaded Evidence</h4>
                    <div class="complaint-images" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${complaint.attachments.map(attachment => `
                            <div class="image-item" style="text-align: center;">
                                <img src="data:${attachment.mime_type};base64,${attachment.data}" alt="${attachment.filename}" style="max-width: 300px; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">${attachment.filename}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
                
                <div class="detail-actions">
                    ${complaint.status === 'Resolved' ? 
                        '<button class="btn-primary btn-feedback"><i class="fas fa-comment-alt"></i> Give Feedback</button>' : 
                        '<button class="btn-primary btn-message"><i class="fas fa-envelope"></i> Send Message</button>'}
                    <button class="btn-secondary close-details">Close</button>
                </div>
            </div>
        `;
        
        // Open the modal
        const modal = document.getElementById('complaint-details-modal');
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Add event listener for close button
        detailsContent.querySelector('.close-details')?.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
    } catch (error) {
        console.error('Error loading complaint details:', error);
        alert('Failed to load complaint details. Please try again.');
        
        // If there's an authentication error, redirect to login
        if (error.status === 401) {
            window.location.href = '/auth/login';
        }
    }
}

// Show all complaints in a modal
async function showAllComplaints() {
    try {
        const response = await fetch('/complaint/all', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'  // Include session cookies
        });
        
        // Check if response redirects to login (session expired)
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        
        const complaints = await response.json();
        
        const detailsContent = document.getElementById('complaint-details-content');
        detailsContent.innerHTML = `
            <h2>All Your Complaints</h2>
            <div class="all-complaints-list">
                ${complaints.length === 0 ? 
                    '<p class="no-complaints">You have not submitted any complaints yet.</p>' : 
                    complaints.map(complaint => {
                        const complaintDate = new Date(complaint.submitted_date);
                        const formattedDate = complaintDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        const statusClass = getStatusClass(complaint.status);
                        
                        return `
                            <div class="complaint-summary">
                                <div class="complaint-header">
                                    <span class="complaint-id">${complaint.id}</span>
                                    <span class="status-badge ${statusClass}">${complaint.status}</span>
                                </div>
                                <h3 class="complaint-title">${complaint.title}</h3>
                                <p class="complaint-date"><i class="far fa-calendar-alt"></i> Submitted: ${formattedDate}</p>
                                <p class="complaint-location"><i class="fas fa-map-marker-alt"></i> ${complaint.location}</p>
                                <button class="btn-view view-summary" data-id="${complaint.id}">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </div>
                        `;
                    }).join('')
                }
            </div>
            <div class="modal-actions">
                <button class="btn-secondary close-details">Close</button>
            </div>
        `;
        
         // Open the modal
         const modal = document.getElementById('complaint-details-modal');
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Add event listener for close button
        detailsContent.querySelector('.close-details')?.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
        // Add event listeners for view buttons
        detailsContent.querySelectorAll('.view-summary').forEach(btn => {
            btn.addEventListener('click', () => {
                const complaintId = btn.dataset.id;
                showComplaintDetails(complaintId);
            });
        });
        
    } catch (error) {
        console.error('Error loading all complaints:', error);
        alert('Failed to load complaints. Please try again.');
        
        // If there's an authentication error, redirect to login
        if (error.status === 401) {
            window.location.href = '/auth/login';
        }
    }
}

// Helper function to get CSS class for status
function getStatusClass(status) {
    const statusMap = {
        'New': 'new',
        'In Progress': 'in-progress',
        'Resolved': 'resolved',
        'Escalated': 'escalated',
        'Pending': 'pending',
        'Closed': 'closed',
        'Rejected': 'rejected'
    };
    return statusMap[status] || '';
}

// Handle message submission
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-message')) {
        e.preventDefault();
        const complaintId = e.target.closest('.complaint-card')?.querySelector('.complaint-id')?.textContent ||
                           document.querySelector('.complaint-details-card .complaint-id')?.textContent;
        
        if (complaintId) {
            // Open compose message modal and pre-fill complaint ID
            const composeModal = document.getElementById('compose-message-modal');
            const complaintSelect = document.getElementById('message-complaint');
            
            if (composeModal && complaintSelect) {
                // Load officials list
                if (typeof loadOfficialsForMessaging === 'function') {
                    loadOfficialsForMessaging();
                }
                
                // Pre-select the complaint
                setTimeout(() => {
                    const options = Array.from(complaintSelect.options);
                    const matchingOption = options.find(opt => opt.textContent.includes(complaintId));
                    if (matchingOption) {
                        complaintSelect.value = matchingOption.value;
                    }
                }, 500); // Wait for complaints to load
                
                // Open the modal
                composeModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }
    }
});

// Show message modal - OLD VERSION - No longer used
// Kept for reference, can be deleted
/*
async function showMessageModal(complaintId) {
    // This function is no longer used
    // Messages now open directly in compose modal
}
*/

// Initialize real-time updates
function initializeRealTimeUpdates() {
    // This would connect to a WebSocket or use polling in a real application
    // For now, we'll just refresh the data periodically
    setInterval(() => {
        loadRecentComplaints();
        updateNotificationCounts();
    }, 300000); // Refresh every 5 minutes
    
    // Also refresh when the window gains focus
    window.addEventListener('focus', () => {
        loadRecentComplaints();
        updateNotificationCounts();
    });
}

// Initialize the application
function initializeApp() {
    // Check authentication status
    fetch('/auth/status', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && !data.authenticated) {
            window.location.href = '/auth/login';
        } else {
            // User is authenticated, continue with initialization
            initializeRealTimeUpdates();
            
            // Update user profile information
            if (data && data.user) {
                updateUserProfile(data.user);
            }
        }
    })
    .catch(error => {
        console.error('Authentication check failed:', error);
    });
}

// Update user profile information in the UI
function updateUserProfile(user) {
    const profileLinks = document.querySelectorAll('a[href="#profile"]');
    profileLinks.forEach(link => {
        if (link.querySelector('i.fa-user-circle')) {
            link.innerHTML = `<i class="fas fa-user-circle"></i> ${user.name || 'Profile'}`;
        }
    });
    
    // Update any other user-specific UI elements
}

// Start the application
initializeApp();
    </script>
        <script src="{{ url_for('static', filename='js/messaging.js') }}"></script>
</body>
</html>