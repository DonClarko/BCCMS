<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admindashboard.css') }}">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"></script>
    <script src="{{ url_for('static', filename='js/firebaseConfig.js') }}"></script>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">BCCMS Admin</div>
                <ul class="menu">
                    <li><a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" class="nav-quick-link" data-section="user-management"><i class="fas fa-users"></i> Users</a></li>
                    <li><a href="#" class="nav-quick-link" data-section="pending-approvals"><i class="fas fa-user-tie"></i> Approvals</a></li>
                    <li><a href="#" class="nav-quick-link" data-section="complaints-management"><i class="fas fa-exclamation-circle"></i> Complaints</a></li>
                    <li><a href="#messages"><i class="fas fa-envelope"></i> Messages <span class="notification-badge" id="messages-badge" style="display: none;">0</span></a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications <span class="notification-badge" id="notifications-badge" style="display: none;">0</span></a></li>
                    <li><a href="#feedback"><i class="fas fa-comment-alt"></i> Feedback</a></li>
                    <li><a href="{{ url_for('auth.show_auth', form_type='login') }}" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Welcome Section -->
        <section class="hero">
            <h1>Admin Dashboard</h1>
            <p>Welcome back, Admin! Manage your barangay services efficiently.</p>
        </section>

        <!-- Dashboard Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon residents">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Residents</h3>
                    <p class="count" id="total-residents">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon officials">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="stat-info">
                    <h3>Barangay Officials</h3>
                    <p class="count" id="total-officials">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>Pending Requests</h3>
                    <p class="count" id="pending-requests">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon events">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <h3>Upcoming Events</h3>
                    <p class="count" id="upcoming-events">0</p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <section id="admin-dashboard" class="dashboard">
            <div class="sidebar">
                <h3>Quick Navigation</h3>
                <ul>
                    <li><a href="#" class="quick-nav-link active" data-section="recent-activity"><i class="fas fa-clock"></i> Recent Activity</a></li>
                    <li><a href="#" class="quick-nav-link" data-section="complaints-management"><i class="fas fa-exclamation-circle"></i> Complaints Management <span class="notification-badge" id="complaints-badge">0</span></a></li>
                    <li><a href="#" class="quick-nav-link" data-section="pending-approvals"><i class="fas fa-user-check"></i> Pending Approvals <span class="notification-badge" id="pending-reg-badge" style="display: none;">0</span></a></li>
                    <li><a href="#" class="quick-nav-link" data-section="user-management"><i class="fas fa-users-cog"></i> User Management</a></li>
                </ul>
            </div>
            <div class="content-area">
                <!-- Recent Activity Section -->
                <div id="recent-activity-section" class="quick-nav-content active">
                    <div class="section-header">
                        <h2>Recent Activity</h2>
                        <a href="#" class="view-all">View All</a>
                    </div>
                    <div class="activity-list" id="activity-list">
                        <p class="loading">Loading activities...</p>
                    </div>
                </div>

                <!-- Complaints Management Section -->
                <div id="complaints-management-section" class="quick-nav-content">
                    <div class="section-header">
                        <h2>Complaint Management</h2>
                        <select id="complaint-status-filter" class="role-filter" onchange="filterComplaintsByStatus()">
                            <option value="all">All Status</option>
                            <option value="pending">Pending Review</option>
                            <option value="in-progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="escalated">Escalated</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tracking ID</th>
                                    <th>Title</th>
                                    <th>Resident</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="complaints-table-body">
                                <tr>
                                    <td colspan="6" class="loading">Loading complaints...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pending Approvals Section -->
                <div id="pending-approvals-section" class="quick-nav-content">
                    <div class="section-header">
                        <h2>Pending Official Registrations</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Date Applied</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-registrations-body">
                                <tr>
                                    <td colspan="5" class="loading">Loading pending registrations...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="user-management-section" class="quick-nav-content">
                    <div class="section-header">
                        <h2>User Management</h2>
                        <select id="user-role-filter" class="role-filter" onchange="filterUsersByRole()">
                            <option value="all">All Roles</option>
                            <option value="resident">Resident</option>
                            <option value="official">Official</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                <td colspan="4" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="card-grid" style="margin-top: 40px;">
            <div class="card">
                <h3>Complaint Analytics</h3>
                <p>Total complaints: <span id="analytics-total">0</span></p>
                <p>Resolved: <span id="analytics-resolved">0</span> (<span id="analytics-resolved-pct">0</span>%)</p>
                <p>In progress: <span id="analytics-in-progress">0</span> (<span id="analytics-in-progress-pct">0</span>%)</p>
                <p>Escalated: <span id="analytics-escalated">0</span> (<span id="analytics-escalated-pct">0</span>%)</p>
            </div>
            <div class="card">
                <h3>Resolution Metrics</h3>
                <p>Average resolution time: <span id="analytics-avg-time">0</span> days</p>
                <p>Fastest resolution: <span id="analytics-fastest">0</span> hours</p>
                <p>Currently pending: <span id="analytics-pending">0</span></p>
                <p>SLA compliance rate: <span id="analytics-sla">0</span>%</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h3>About BCCMS</h3>
                <p>A digital platform for efficient complaint management in the barangay.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#dashboard">Dashboard</a></li>
                    <li><a href="#residents">Residents</a></li>
                    <li><a href="#complaints">Complaints</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact Us</h3>
                <p>Email: admin@bccms.com</p>
                <p>Phone: +63 123 456 7890</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Barangay Complaint Management System. All rights reserved.</p>
        </div>
    </footer>

    <!-- User Management Full Modal -->
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-btn" onclick="closeModal('user-details-modal')">&times;</span>
            <h2><i class="fas fa-user"></i> User Details</h2>
            <div id="user-details-content" style="padding: 20px 0;">
                <p style="text-align: center; color: #666;">Loading user details...</p>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="closeModal('messages-modal')">&times;</span>
            <h2><i class="fas fa-envelope"></i> Messages</h2>
            <button id="compose-message-btn-admin" class="btn-primary" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i> New Message
            </button>
            <div class="messages-list" id="admin-messages-list" style="max-height: 500px; overflow-y: auto;">
                <p style="text-align: center; padding: 20px; color: #666;">Loading messages...</p>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="closeModal('notifications-modal')">&times;</span>
            <h2><i class="fas fa-bell"></i> Notifications</h2>
            <button id="mark-all-read-btn" class="btn-secondary" style="margin-bottom: 15px;">
                <i class="fas fa-check-double"></i> Mark All as Read
            </button>
            <div class="notifications-list" id="admin-notifications-list" style="max-height: 500px; overflow-y: auto;">
                <p style="text-align: center; padding: 20px; color: #666;">Loading notifications...</p>
            </div>
        </div>
    </div>

    <!-- Complaint Details Modal -->
    <div id="complaint-details-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-btn" onclick="closeModal('complaint-details-modal')">&times;</span>
            <div id="complaint-details-content">
                <!-- Content will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-update-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" onclick="closeModal('status-update-modal')">&times;</span>
            <h2><i class="fas fa-edit"></i> Update Complaint Status</h2>
            <form id="status-update-form">
                <input type="hidden" id="complaint-id-status" name="complaint_id">
                <div class="form-group">
                    <label for="status-select">Status:</label>
                    <select id="status-select" name="status" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select Status</option>
                        <option value="New">New</option>
                        <option value="Pending Review">Pending Review</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Escalated">Escalated</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-notes">Notes:</label>
                    <textarea id="status-notes" name="notes" rows="4" placeholder="Enter details about this status update..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="notify-resident" name="notify_resident" checked>
                        Notify resident about this update
                    </label>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('status-update-modal')">Cancel</button>
                    <button type="submit" class="btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Resident Modal -->
    <div id="message-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" onclick="closeModal('message-modal')">&times;</span>
            <h2><i class="fas fa-envelope"></i> Send Message</h2>
            <form id="message-form">
                <input type="hidden" id="message-complaint-id" name="complaint_id">
                <div class="form-group">
                    <label for="recipient-type">Recipient Type:</label>
                    <select id="recipient-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="resident">Resident</option>
                        <option value="official">Barangay Official</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message-recipient">Select Recipient:</label>
                    <select id="message-recipient" name="recipient" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Choose a recipient --</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="message-complaint-select">Related Complaint (Optional):</label>
                    <select id="message-complaint-select" name="complaint" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Select complaint (optional) --</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="message-subject">Subject:</label>
                    <input type="text" id="message-subject" name="subject" placeholder="Message subject..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label for="message-content">Message:</label>
                    <textarea id="message-content" name="content" placeholder="Type your message here..." required rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('message-modal')">Cancel</button>
                    <button type="submit" class="btn-primary"><i class="fas fa-paper-plane"></i> Send Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="closeModal('feedback-modal')">&times;</span>
            <h2><i class="fas fa-comment-alt"></i> Resident Feedback</h2>
            <div class="feedback-filter" style="margin-bottom: 15px;">
                <select id="feedback-filter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">All Feedback</option>
                    <option value="positive">Positive (4-5 stars)</option>
                    <option value="neutral">Neutral (3 stars)</option>
                    <option value="negative">Negative (1-2 stars)</option>
                </select>
            </div>
            <div class="feedback-list" id="feedback-list" style="max-height: 500px; overflow-y: auto;">
                <p style="text-align: center; padding: 20px; color: #666;">Loading feedback...</p>
            </div>
        </div>
    </div>

    <script>
        // Current user email (to exclude from recipient lists)
        const currentUserEmail = "{{ user_email }}";
        
        // Close modal helper function
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Open modal helper function
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch('/messages');
                const messages = await response.json();
                
                const messagesList = document.getElementById('admin-messages-list');
                if (!messagesList) return;
                
                if (!messages || messages.length === 0) {
                    messagesList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No messages yet</p>';
                    return;
                }
                
                // Group messages by conversation partner
                const conversations = {};
                
                messages.forEach(msg => {
                    let partnerEmail, partnerName;
                    
                    if (msg.isSent) {
                        partnerEmail = msg.to_email;
                        partnerName = msg.to_name || msg.to_email;
                    } else {
                        partnerEmail = msg.from_email;
                        partnerName = msg.from_name || msg.from_email;
                    }
                    
                    if (!conversations[partnerEmail]) {
                        conversations[partnerEmail] = {
                            name: partnerName,
                            email: partnerEmail,
                            messages: [],
                            latestTimestamp: msg.timestamp
                        };
                    }
                    
                    conversations[partnerEmail].messages.push({
                        ...msg,
                        isFromMe: msg.isSent === true
                    });
                    conversations[partnerEmail].latestTimestamp = msg.timestamp;
                });

                // Sort conversations by latest message
                const sortedConversations = Object.values(conversations).sort((a, b) => {
                    return new Date(b.latestTimestamp) - new Date(a.latestTimestamp);
                });

                messagesList.innerHTML = '';
                
                // Display conversations
                sortedConversations.forEach(convo => {
                    const latestMsg = convo.messages[convo.messages.length - 1];
                    const unreadCount = convo.messages.filter(m => !m.read && !m.isSent).length;
                    
                    const card = document.createElement('div');
                    card.className = `message-card ${unreadCount > 0 ? 'unread' : ''}`;
                    card.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #0466c8; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;';
                    
                    const unreadIndicator = unreadCount > 0 ? `<span style="background: #ff6b6b; color: white; border-radius: 50%; width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${unreadCount}</span>` : '';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <i class="fas fa-user-circle" style="font-size: 24px; color: #0466c8;"></i>
                                    <h4 style="margin: 0; color: #333; font-size: 16px;">${convo.name}</h4>
                                    ${unreadIndicator}
                                </div>
                                <p style="margin: 5px 0; color: #666; font-size: 13px;">${latestMsg.subject || 'No Subject'}</p>
                                <p style="margin: 5px 0; color: #999; font-size: 12px;">${convo.messages.length} message(s) â€¢ ${formatMessageDate(latestMsg.timestamp)}</p>
                            </div>
                        </div>
                    `;
                    
                    messagesList.appendChild(card);
                    
                    // Add click to view conversation
                    card.addEventListener('click', () => showConversationAdmin(convo));
                });
                
                updateMessagesBadge(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
                const messagesList = document.getElementById('admin-messages-list');
                if (messagesList) {
                    messagesList.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading messages</p>';
                }
            }
        }

        // Show conversation modal for admin
        function showConversationAdmin(conversation) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            let messagesHTML = '';
            
            // Sort messages by timestamp (oldest first)
            const sortedMessages = [...conversation.messages].sort((a, b) => {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            sortedMessages.forEach(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleString();
                const isFromMe = msg.isSent === true;
                const senderName = isFromMe ? 'You (Admin)' : (msg.from_name || msg.from_email);
                
                if (isFromMe) {
                    messagesHTML += `
                        <div style="display: flex; justify-content: flex-end; margin: 15px 0;">
                            <div style="max-width: 70%; background: #0466c8; color: white; border-radius: 15px 15px 5px 15px; padding: 12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="margin: 0 0 5px 0; font-size: 13px; opacity: 0.9; font-weight: 600;">${senderName}</p>
                                ${msg.subject ? `<p style="margin: 0 0 8px 0; font-size: 13px; opacity: 0.85; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px;">Subject: ${msg.subject}</p>` : ''}
                                <p style="margin: 0 0 8px 0; white-space: pre-wrap; font-size: 14px; line-height: 1.4;">${msg.content}</p>
                                <p style="margin: 0; font-size: 11px; opacity: 0.75; text-align: right;">${timestamp}</p>
                            </div>
                        </div>
                    `;
                } else {
                    messagesHTML += `
                        <div style="display: flex; justify-content: flex-start; margin: 15px 0;">
                            <div style="max-width: 70%; background: #f0f0f0; color: #333; border-radius: 15px 15px 15px 5px; padding: 12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: 600; color: #0466c8;">${senderName}</p>
                                ${msg.subject ? `<p style="margin: 0 0 8px 0; font-size: 13px; color: #666; font-weight: 500; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Subject: ${msg.subject}</p>` : ''}
                                <p style="margin: 0 0 8px 0; white-space: pre-wrap; font-size: 14px; line-height: 1.4;">${msg.content}</p>
                                <p style="margin: 0; font-size: 11px; color: #999; text-align: left;">${timestamp}</p>
                            </div>
                        </div>
                    `;
                }
            });
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 750px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden;">
                    <div style="border-bottom: 2px solid #0466c8; padding: 15px 20px; background: linear-gradient(135deg, #0466c8 0%, #0353a4 100%);">
                        <h2 style="margin: 0; display: flex; align-items: center; justify-content: space-between; color: white;">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-comments"></i>
                                <span>${conversation.name}</span>
                            </span>
                            <button class="close-btn" style="background: none; border: none; font-size: 28px; cursor: pointer; color: white; opacity: 0.9; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">&times;</button>
                        </h2>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: rgba(255,255,255,0.9);">${conversation.email}</p>
                    </div>
                    
                    <div style="flex: 1; overflow-y: auto; padding: 20px; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);">
                        ${messagesHTML}
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding: 20px; background: #f8f9fa;">
                        <h4 style="margin: 0 0 12px 0; font-size: 15px; color: #333;"><i class="fas fa-reply"></i> Send Reply</h4>
                        <form id="admin-reply-form" style="display: flex; flex-direction: column; gap: 12px;">
                            <input type="text" id="admin-reply-subject" placeholder="Subject" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" required onfocus="this.style.borderColor='#0466c8'" onblur="this.style.borderColor='#dee2e6'">
                            <textarea id="admin-reply-content" placeholder="Type your message here..." style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 100px; transition: border-color 0.2s;" required onfocus="this.style.borderColor='#0466c8'" onblur="this.style.borderColor='#dee2e6'"></textarea>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="btn-secondary" style="padding: 10px 20px; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                                <button type="submit" class="btn-primary" style="padding: 10px 24px; background: #0466c8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: background 0.2s;" onmouseover="this.style.background='#0353a4'" onmouseout="this.style.background='#0466c8'">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Close button handler
            modal.querySelector('.close-btn').addEventListener('click', () => {
                modal.remove();
                document.body.style.overflow = 'auto';
            });
            
            // Cancel button handler
            modal.querySelector('.btn-secondary').addEventListener('click', () => {
                modal.remove();
                document.body.style.overflow = 'auto';
            });
            
            // Form submission
            modal.querySelector('#admin-reply-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const subject = modal.querySelector('#admin-reply-subject').value;
                const content = modal.querySelector('#admin-reply-content').value;
                
                if (!subject || !content) {
                    alert('Please fill in all fields');
                    return;
                }
                
                try {
                    const response = await fetch('/messages/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipient: conversation.email,
                            subject: subject,
                            content: content,
                            complaint_id: null
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Message sent successfully!');
                        modal.remove();
                        document.body.style.overflow = 'auto';
                        loadMessages();
                    } else {
                        alert('Error: ' + (result.message || 'Failed to send message'));
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                }
            });
            
            // Click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/notifications/list');
                const notifications = await response.json();
                
                const notificationsList = document.getElementById('admin-notifications-list');
                if (!notificationsList) return;
                
                if (!notifications || notifications.length === 0) {
                    notificationsList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No notifications yet</p>';
                    return;
                }
                
                notificationsList.innerHTML = '';
                notifications.forEach(notification => {
                    const notifCard = document.createElement('div');
                    notifCard.className = `notification-card ${notification.read ? '' : 'unread'}`;
                    notifCard.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #f57c00; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                    
                    const unreadIndicator = notification.read ? '' : '<span style="display: inline-block; width: 8px; height: 8px; background: #f44336; border-radius: 50%; margin-left: 8px;"></span>';
                    
                    notifCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h4 style="margin: 0; color: #333;">${notification.title}${unreadIndicator}</h4>
                            <span style="font-size: 12px; color: #999;">${formatMessageDate(notification.timestamp || notification.created_at)}</span>
                        </div>
                        <p style="margin: 5px 0; color: #555; font-size: 14px;">${notification.message}</p>
                        ${!notification.read ? `<button onclick="markNotificationRead('${notification.id}')" style="margin-top: 8px; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            <i class="fas fa-check"></i> Mark as Read
                        </button>` : ''}
                    `;
                    notificationsList.appendChild(notifCard);
                });
                
                updateNotificationsBadge(notifications);
            } catch (error) {
                console.error('Error loading notifications:', error);
                const notificationsList = document.getElementById('admin-notifications-list');
                if (notificationsList) {
                    notificationsList.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading notifications</p>';
                }
            }
        }

        // Format message date
        function formatMessageDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMinutes = Math.floor(diffTime / (1000 * 60));
                    return diffMinutes <= 1 ? 'Just now' : `${diffMinutes} min ago`;
                }
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Update messages badge
        function updateMessagesBadge(messages) {
            const badge = document.getElementById('messages-badge');
            if (badge) {
                // Count only received messages (not sent) that are unread
                const unreadCount = messages.filter(m => !m.read && !m.isSent).length;
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            }
        }

        // Update notifications badge
        function updateNotificationsBadge(notifications) {
            const badge = document.getElementById('notifications-badge');
            if (badge) {
                const unreadCount = notifications.filter(n => !n.read).length;
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            }
        }

        // View message details
        function viewMessageDetails(messageId) {
            alert('View message details: ' + messageId + '\n\nThis will show full message content.');
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch('/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ notification_id: notificationId })
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/notifications/mark-all-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Load admin dashboard data
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadRecentActivity();
            loadComplaints();
            loadPendingRegistrations();
            loadUsers();
            loadAnalytics();
            loadMessages();
            loadNotifications();
            
            // Quick Navigation functionality
            function switchQuickNavSection(sectionName) {
                // Hide all quick nav content sections
                document.querySelectorAll('.quick-nav-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show the selected section
                const targetSection = document.getElementById(sectionName + '-section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Update sidebar active state
                document.querySelectorAll('.quick-nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.section === sectionName) {
                        link.classList.add('active');
                    }
                });
            }
            
            // Quick navigation sidebar links
            document.querySelectorAll('.quick-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionName = this.dataset.section;
                    switchQuickNavSection(sectionName);
                });
            });
            
            // Top navbar quick links (Users, Approvals, Complaints)
            document.querySelectorAll('.nav-quick-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionName = this.dataset.section;
                    switchQuickNavSection(sectionName);
                });
            });
            
            // Messages navigation link handler
            document.querySelectorAll('a[href="#messages"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('messages-modal');
                    loadMessages();
                });
            });
            
            // Notifications navigation link handler
            document.querySelectorAll('a[href="#notifications"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('notifications-modal');
                    loadNotifications();
                });
            });
            
            // Feedback navigation link handler
            document.querySelectorAll('a[href="#feedback"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('feedback-modal');
                    loadFeedback();
                });
            });
            
            // Load officials for messaging (admin can message officials too)
            async function loadOfficialsForMessaging() {
                try {
                    const response = await fetch('/officials/list');
                    const officials = await response.json();
                    
                    const recipientSelect = document.getElementById('message-recipient');
                    if (!recipientSelect) return;
                    
                    // Clear existing options except the first one
                    while (recipientSelect.options.length > 1) {
                        recipientSelect.remove(1);
                    }
                    
                    // Add official options (excluding current user)
                    officials.forEach(official => {
                        // Skip if this is the current user
                        if (official.email === currentUserEmail) {
                            return;
                        }
                        
                        const option = document.createElement('option');
                        option.value = official.email;
                        option.textContent = `${official.name} (${official.email})`;
                        recipientSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading officials:', error);
                }
            }
            
            // Compose message button handler
            const composeMessageBtn = document.getElementById('compose-message-btn-admin');
            if (composeMessageBtn) {
                composeMessageBtn.addEventListener('click', function() {
                    closeModal('messages-modal');
                    openModal('message-modal');
                    
                    // Reset recipient type to resident
                    const recipientType = document.getElementById('recipient-type');
                    if (recipientType) {
                        recipientType.value = 'resident';
                    }
                    
                    // Load residents by default
                    if (typeof loadResidentsForMessaging === 'function') {
                        loadResidentsForMessaging();
                    }
                    
                    // Load all complaints initially using shared function
                    if (typeof loadComplaintsForMessaging === 'function') {
                        loadComplaintsForMessaging(false); // false = not official dashboard
                    }
                });
            }
            
            // Add event listener for recipient type change
            const recipientTypeSelect = document.getElementById('recipient-type');
            if (recipientTypeSelect) {
                recipientTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    
                    if (selectedType === 'resident') {
                        // Load residents
                        if (typeof loadResidentsForMessaging === 'function') {
                            loadResidentsForMessaging();
                        }
                        // Show complaint dropdown
                        const complaintGroup = document.getElementById('message-complaint-select')?.closest('.form-group');
                        if (complaintGroup) complaintGroup.style.display = 'block';
                    } else if (selectedType === 'official') {
                        // Load officials
                        loadOfficialsForMessaging();
                        // Hide complaint dropdown (officials don't have complaints)
                        const complaintGroup = document.getElementById('message-complaint-select')?.closest('.form-group');
                        if (complaintGroup) complaintGroup.style.display = 'none';
                    }
                });
            }
            
            // Add event listener for resident selection to filter complaints
            const recipientSelect = document.getElementById('message-recipient');
            if (recipientSelect) {
                recipientSelect.addEventListener('change', function() {
                    const selectedEmail = this.value;
                    // Use shared filtering function from messaging.js
                    if (typeof filterComplaintsByResident === 'function') {
                        filterComplaintsByResident(selectedEmail, false); // false = not official dashboard
                    }
                });
            }
            
            // Mark all notifications as read button handler
            const markAllReadBtn = document.getElementById('mark-all-read-btn');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function() {
                    markAllNotificationsRead();
                });
            }
            
            // Refresh messages and notifications every 30 seconds
            setInterval(() => {
                loadMessages();
                loadNotifications();
            }, 30000);
            
            // Status update form submission
            const statusUpdateForm = document.getElementById('status-update-form');
            if (statusUpdateForm) {
                statusUpdateForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const complaintId = document.getElementById('complaint-id-status').value;
                    const status = document.getElementById('status-select').value;
                    const notes = document.getElementById('status-notes').value;
                    const notifyResident = document.getElementById('notify-resident').checked;
                    
                    try {
                        const response = await fetch('/complaint/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                complaint_id: complaintId,
                                status: status,
                                notes: notes,
                                notify_resident: notifyResident
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Complaint status updated successfully!');
                            closeModal('status-update-modal');
                            loadComplaints();
                            loadStats();
                            loadAnalytics();
                        } else {
                            alert('Error updating complaint: ' + data.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error updating complaint status');
                    }
                });
            }
            
            // Message form submission
            const messageForm = document.getElementById('message-form');
            if (messageForm) {
                messageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const toEmail = document.getElementById('message-recipient').value;
                    const subject = document.getElementById('message-subject').value;
                    const content = document.getElementById('message-content').value;
                    const complaintId = document.getElementById('message-complaint-select').value || null;
                    
                    if (!toEmail) {
                        alert('Please select a resident');
                        return;
                    }
                    
                    if (!subject || !content) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/message/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                to_email: toEmail,
                                subject: subject,
                                content: content,
                                complaint_id: complaintId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Message sent successfully!');
                            closeModal('message-modal');
                            messageForm.reset();
                            loadMessages(); // Refresh messages list
                        } else {
                            alert('Error sending message: ' + (data.error || data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error sending message');
                    }
                });
            }
        });

        // Load dashboard statistics
        function loadStats() {
            fetch('/admin/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-residents').textContent = data.total_residents || 0;
                    document.getElementById('total-officials').textContent = data.total_officials || 0;
                    document.getElementById('pending-requests').textContent = data.pending_requests || 0;
                    document.getElementById('upcoming-events').textContent = data.upcoming_events || 0;
                    
                    // Update complaints badge
                    const badge = document.getElementById('complaints-badge');
                    if (badge) {
                        badge.textContent = data.pending_requests || 0;
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // Load recent activity
        function loadRecentActivity() {
            fetch('/admin/recent-activity')
                .then(response => response.json())
                .then(activities => {
                    const activityList = document.getElementById('activity-list');
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = '<p class="loading">No recent activity</p>';
                        return;
                    }

                    activityList.innerHTML = '';
                    activities.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'activity-item';
                        
                        const iconClass = activity.type === 'new_user' ? 'new-user' : 
                                        activity.icon === 'check-circle' ? 'document' : 'document';
                        
                        activityItem.innerHTML = `
                            <div class="activity-icon ${iconClass}">
                                <i class="fas fa-${activity.icon}"></i>
                            </div>
                            <div class="activity-details">
                                <p>${activity.message}</p>
                                <span class="timestamp">${activity.timestamp}</span>
                            </div>
                        `;
                        activityList.appendChild(activityItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading activity:', error);
                    document.getElementById('activity-list').innerHTML = '<p class="loading">Error loading activities</p>';
                });
        }

        // Store all complaints for filtering
        let allComplaints = [];

        // Load complaints
        function loadComplaints() {
            fetch('/admin/complaints')
                .then(response => response.json())
                .then(complaints => {
                    allComplaints = complaints; // Store for filtering
                    displayComplaints(complaints);
                })
                .catch(error => {
                    console.error('Error loading complaints:', error);
                    document.getElementById('complaints-table-body').innerHTML = 
                        '<tr><td colspan="6" class="loading">Error loading complaints</td></tr>';
                });
        }

        // Display complaints in the table
        function displayComplaints(complaints) {
            const tbody = document.getElementById('complaints-table-body');
            
            if (complaints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No complaints found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            complaints.forEach(complaint => {
                const row = document.createElement('tr');
                row.setAttribute('data-status', complaint.status.toLowerCase().replace(/\s+/g, '-'));
                
                // Format date
                let formattedDate = 'N/A';
                if (complaint.date) {
                    try {
                        const date = new Date(complaint.date);
                        formattedDate = date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    } catch (e) {
                        formattedDate = complaint.date;
                    }
                }

                // Determine status class
                const statusClass = complaint.status.toLowerCase().replace(/\s+/g, '-');
                
                row.innerHTML = `
                    <td>${complaint.id}</td>
                    <td>${complaint.title}</td>
                    <td>${complaint.resident}</td>
                    <td>${formattedDate}</td>
                    <td><span class="status ${statusClass}">${complaint.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn view" onclick="viewComplaint('${complaint.id}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn edit" onclick="updateComplaintStatus('${complaint.id}')" title="Update Status"><i class="fas fa-edit"></i></button>
                            <button class="btn message" onclick="messageResident('${complaint.id}', '${complaint.resident_email}')" title="Message Resident"><i class="fas fa-envelope"></i></button>
                            <button class="btn delete" onclick="deleteComplaint('${complaint.id}')" title="Delete Complaint"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter complaints by status
        function filterComplaintsByStatus() {
            const filter = document.getElementById('complaint-status-filter').value;
            let filteredComplaints = allComplaints;
            
            if (filter !== 'all') {
                filteredComplaints = allComplaints.filter(complaint => {
                    const statusKey = complaint.status.toLowerCase().replace(/\s+/g, '-');
                    return statusKey === filter || statusKey.includes(filter);
                });
            }
            
            displayComplaints(filteredComplaints);
        }

        // Store all users for filtering
        let allUsers = [];

        // Load users
        function loadUsers() {
            fetch('/admin/users')
                .then(response => response.json())
                .then(users => {
                    allUsers = users; // Store for filtering
                    displayUsers(users, 'users-table-body');
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    document.getElementById('users-table-body').innerHTML = 
                        '<tr><td colspan="4" class="loading">Error loading users</td></tr>';
                });
        }

        // Display users in a table body
        function displayUsers(users, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.setAttribute('data-role', user.role);
                
                // Determine role display
                let roleClass = user.role;
                let roleText = user.role;
                if (user.is_admin) {
                    roleClass = 'admin';
                    roleText = 'Admin';
                }
                
                // Determine if user is blocked
                const isBlocked = user.status === 'blocked';
                const blockBtnClass = isBlocked ? 'unblock' : 'block';
                const blockBtnIcon = isBlocked ? 'fa-unlock' : 'fa-ban';
                const blockBtnTitle = isBlocked ? 'Unblock User' : 'Block User';
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role ${roleClass}">${roleText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn view" onclick="viewUserDetails('${user.uid}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn message" onclick="openMessageToUser('${user.uid}', '${user.name}', '${user.email}', '${user.role}')" title="Send Message"><i class="fas fa-envelope"></i></button>
                            <button class="btn ${blockBtnClass}" onclick="toggleBlockUser('${user.uid}', '${user.name}', ${isBlocked})" title="${blockBtnTitle}"><i class="fas ${blockBtnIcon}"></i></button>
                            <button class="btn delete" onclick="deleteUser('${user.uid}', '${user.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter users by role
        function filterUsersByRole() {
            const filter = document.getElementById('user-role-filter').value;
            let filteredUsers = allUsers;
            
            if (filter !== 'all') {
                filteredUsers = allUsers.filter(user => user.role === filter);
            }
            
            displayUsers(filteredUsers, 'users-table-body');
        }

        // Load pending registrations
        function loadPendingRegistrations() {
            fetch('/admin/pending-registrations')
                .then(response => response.json())
                .then(registrations => {
                    const tbody = document.getElementById('pending-registrations-body');
                    const badge = document.getElementById('pending-reg-badge');
                    const section = document.getElementById('pending-registrations-section');
                    
                    if (registrations.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="loading">No pending registrations</td></tr>';
                        badge.style.display = 'none';
                        return;
                    }

                    // Show badge with count
                    badge.textContent = registrations.length;
                    badge.style.display = 'inline-block';

                    tbody.innerHTML = '';
                    registrations.forEach(reg => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        let dateDisplay = 'N/A';
                        if (reg.created_at) {
                            const date = new Date(reg.created_at);
                            dateDisplay = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                        
                        row.innerHTML = `
                            <td>${reg.name}</td>
                            <td>${reg.email}</td>
                            <td>${reg.phone || 'N/A'}</td>
                            <td>${dateDisplay}</td>
                            <td>
                                <div class="action-buttons" style="display: flex; gap: 12px; justify-content: center;">
                                    <button class="btn approve" onclick="approveRegistration('${reg.uid}', '${reg.name}')" title="Approve" style="background-color: #28a745; color: white; width: 36px; height: 36px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn reject" onclick="rejectRegistration('${reg.uid}', '${reg.name}')" title="Reject" style="background-color: #dc3545; color: white; width: 36px; height: 36px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading pending registrations:', error);
                    document.getElementById('pending-registrations-body').innerHTML = 
                        '<tr><td colspan="5" class="loading">Error loading pending registrations</td></tr>';
                });
        }

        // Approve registration
        function approveRegistration(uid, name) {
            if (!confirm(`Are you sure you want to approve ${name}'s registration as Barangay Official?`)) {
                return;
            }
            
            fetch(`/admin/approve-registration/${uid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadPendingRegistrations();
                    loadUsers();
                    loadStats();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error approving registration:', error);
                alert('Error approving registration');
            });
        }

        // Reject registration
        function rejectRegistration(uid, name) {
            if (!confirm(`Are you sure you want to reject ${name}'s registration?`)) {
                return;
            }
            
            fetch(`/admin/reject-registration/${uid}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadPendingRegistrations();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error rejecting registration:', error);
                alert('Error rejecting registration');
            });
        }

        // Load analytics
        function loadAnalytics() {
            fetch('/admin/analytics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('analytics-total').textContent = data.total || 0;
                    document.getElementById('analytics-resolved').textContent = data.resolved || 0;
                    document.getElementById('analytics-resolved-pct').textContent = data.resolved_percentage || 0;
                    document.getElementById('analytics-in-progress').textContent = data.in_progress || 0;
                    document.getElementById('analytics-in-progress-pct').textContent = data.in_progress_percentage || 0;
                    document.getElementById('analytics-escalated').textContent = data.escalated || 0;
                    document.getElementById('analytics-escalated-pct').textContent = data.escalated_percentage || 0;
                    document.getElementById('analytics-avg-time').textContent = data.avg_resolution_time || 0;
                    document.getElementById('analytics-fastest').textContent = data.fastest_resolution || 0;
                    document.getElementById('analytics-pending').textContent = data.pending || 0;
                    document.getElementById('analytics-sla').textContent = data.sla_compliance || 0;
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                });
        }

        // View complaint details
        function viewComplaint(complaintId) {
            showComplaintDetails(complaintId);
        }

        // Show complaint details modal
        async function showComplaintDetails(complaintId) {
            try {
                const response = await fetch(`/complaint/details?id=${complaintId}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to fetch complaint details');
                const complaint = await response.json();

                const detailsContent = document.getElementById('complaint-details-content');
                detailsContent.innerHTML = `
                    <h2>Complaint Details - ${complaint.id}</h2>
                    <div class="complaint-details-card">
                        <div class="detail-row">
                            <p><strong>Status:</strong> <span class="status ${complaint.status.toLowerCase().replace(' ', '-')}">${complaint.status}</span></p>
                            <p><strong>Urgency:</strong> <span class="urgency ${complaint.urgency ? complaint.urgency.toLowerCase() : 'low'}">${complaint.urgency || 'N/A'}</span></p>
                        </div>
                        <div class="detail-row">
                            <p><strong>Submitted by:</strong> ${complaint.user_name}</p>
                            <p><strong>Submitted on:</strong> ${new Date(complaint.submitted_date).toLocaleDateString()}</p>
                        </div>
                        <div class="detail-row">
                            <p><strong>Category:</strong> ${complaint.category || 'N/A'}</p>
                            <p><strong>Location:</strong> ${complaint.location || 'N/A'}</p>
                        </div>
                        <div class="detail-row">
                            <h3>Description</h3>
                            <p>${complaint.description}</p>
                        </div>
                        ${complaint.attachments?.length ? `
                        <div class="detail-row">
                            <h3>Uploaded Evidence</h3>
                            <div class="complaint-images">
                                ${complaint.attachments.map(attachment => `
                                    <div class="image-item">
                                        <img src="data:${attachment.mime_type};base64,${attachment.data}" alt="${attachment.filename}" style="max-width: 300px; max-height: 300px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <p style="font-size: 0.85em; color: #666; text-align: center;">${attachment.filename}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        ${complaint.updates?.length ? `
                        <div class="detail-row">
                            <h3>Update History</h3>
                            <div class="update-history">
                                ${complaint.updates.map(update => `
                                    <div class="update-item">
                                        <p><strong>${new Date(update.timestamp).toLocaleString()}</strong></p>
                                        <p>Status changed from ${update.from_status} to ${update.to_status}</p>
                                        ${update.action_note ? `<p>Notes: ${update.action_note}</p>` : ''}
                                        <p>Updated by: ${update.by_official || 'System'}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                        <div class="detail-actions">
                            <button class="btn-secondary close-details">Close</button>
                        </div>
                    </div>
                `;

                const modal = document.getElementById('complaint-details-modal');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';

                detailsContent.querySelector('.close-details')?.addEventListener('click', () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                });
            } catch (error) {
                console.error('Error loading complaint details:', error);
                alert('Failed to load complaint details. Please try again.');
            }
        }

        // Update complaint status
        function updateComplaintStatus(complaintId) {
            const modal = document.getElementById('status-update-modal');
            if (!modal) return;
            
            // Set complaint ID in hidden field
            const complaintIdField = document.getElementById('complaint-id-status');
            if (complaintIdField) {
                complaintIdField.value = complaintId;
            }
            
            // Reset form fields
            const statusSelect = document.getElementById('status-select');
            const statusNotes = document.getElementById('status-notes');
            
            if (statusSelect) statusSelect.selectedIndex = 0;
            if (statusNotes) statusNotes.value = '';
            
            // Show the modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Message resident
        async function messageResident(complaintId, residentEmail) {
            const modal = document.getElementById('message-modal');
            if (!modal) return;
            
            // Load residents if not already loaded
            if (typeof loadResidentsForMessaging === 'function') {
                loadResidentsForMessaging();
            }
            
            // Load all complaints initially
            if (typeof loadComplaintsForMessaging === 'function') {
                loadComplaintsForMessaging(false); // false = not official dashboard
            }
            
            // Pre-select the resident email and complaint after a short delay
            setTimeout(() => {
                const recipientSelect = document.getElementById('message-recipient');
                if (recipientSelect && residentEmail) {
                    // Find and select the option with matching email
                    const options = Array.from(recipientSelect.options);
                    const matchingOption = options.find(opt => opt.value === residentEmail);
                    if (matchingOption) {
                        recipientSelect.value = residentEmail;
                        
                        // Trigger change event to filter complaints by this resident
                        if (typeof filterComplaintsByResident === 'function') {
                            filterComplaintsByResident(residentEmail, false);
                        }
                    }
                }
                
                // Pre-select the complaint in dropdown after filtering
                setTimeout(() => {
                    const complaintSelect = document.getElementById('message-complaint-select');
                    if (complaintSelect && complaintId) {
                        const options = Array.from(complaintSelect.options);
                        const matchingOption = options.find(opt => opt.textContent.includes(complaintId));
                        if (matchingOption) {
                            complaintSelect.value = matchingOption.value;
                        }
                    }
                }, 300);
            }, 500);
            
            // Show the modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Delete complaint
        function deleteComplaint(complaintId) {
            if (!confirm('Are you sure you want to delete this complaint?')) {
                return;
            }

            fetch('/admin/complaint/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: complaintId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Complaint deleted successfully');
                    loadComplaints();
                    loadStats();
                    loadAnalytics();
                } else {
                    alert('Error deleting complaint: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting complaint');
            });
        }

        // Edit user
        // View user details
        function viewUserDetails(userId) {
            openModal('user-details-modal');
            document.getElementById('user-details-content').innerHTML = 
                '<p style="text-align: center; color: #666;">Loading user details...</p>';
            
            fetch(`/admin/user/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.user;
                        
                        // Format dates
                        let createdDate = 'N/A';
                        if (user.created_at) {
                            const date = new Date(user.created_at);
                            createdDate = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                        
                        let approvedDate = 'N/A';
                        if (user.approved_at) {
                            const date = new Date(user.approved_at);
                            approvedDate = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                        
                        // Determine role display
                        let roleDisplay = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                        let roleColor = user.role === 'official' ? '#28a745' : '#17a2b8';
                        
                        // Determine status display
                        let statusDisplay = user.status ? user.status.replace('_', ' ').charAt(0).toUpperCase() + user.status.slice(1).replace('_', ' ') : 'Approved';
                        let statusColor = user.status === 'approved' ? '#28a745' : (user.status === 'blocked' ? '#dc3545' : '#ffc107');
                        let statusIcon = user.status === 'blocked' ? 'fa-ban' : 'fa-check-circle';
                        
                        document.getElementById('user-details-content').innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="text-align: center; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user" style="font-size: 36px; color: white;"></i>
                                    </div>
                                    <h3 style="margin: 0; color: #333;">${user.full_name}</h3>
                                    <span style="background: ${roleColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${roleDisplay}</span>
                                </div>
                                
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-envelope" style="color: #667eea; width: 20px;"></i>
                                        <div>
                                            <small style="color: #999;">Email</small>
                                            <p style="margin: 0; color: #333;">${user.email}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-phone" style="color: #667eea; width: 20px;"></i>
                                        <div>
                                            <small style="color: #999;">Phone</small>
                                            <p style="margin: 0; color: #333;">${user.phone || 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas ${statusIcon}" style="color: ${statusColor}; width: 20px;"></i>
                                        <div>
                                            <small style="color: #999;">Status</small>
                                            <p style="margin: 0; color: ${statusColor}; font-weight: ${user.status === 'blocked' ? 'bold' : 'normal'};">${statusDisplay}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-calendar-plus" style="color: #667eea; width: 20px;"></i>
                                        <div>
                                            <small style="color: #999;">Registered On</small>
                                            <p style="margin: 0; color: #333;">${createdDate}</p>
                                        </div>
                                    </div>
                                    
                                    ${user.approved_at ? `
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-calendar-check" style="color: #28a745; width: 20px;"></i>
                                        <div>
                                            <small style="color: #999;">Approved On</small>
                                            <p style="margin: 0; color: #333;">${approvedDate}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('user-details-content').innerHTML = 
                            '<p style="text-align: center; color: #dc3545;">Error loading user details</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading user details:', error);
                    document.getElementById('user-details-content').innerHTML = 
                        '<p style="text-align: center; color: #dc3545;">Error loading user details</p>';
                });
        }

        // Delete user
        function deleteUser(userId, userName) {
            if (!confirm('Are you sure you want to delete user: ' + userName + '?')) {
                return;
            }

            fetch('/admin/user/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ uid: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully');
                    loadUsers();
                    loadStats();
                } else {
                    alert('Error deleting user: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting user');
            });
        }

        // Open message modal for a specific user
        function openMessageToUser(userId, userName, userEmail, userRole) {
            openModal('message-modal');
            
            const recipientTypeSelect = document.getElementById('recipient-type');
            const recipientSelect = document.getElementById('message-recipient');
            const complaintGroup = document.getElementById('message-complaint-select')?.closest('.form-group');
            
            // Always hide complaint dropdown when messaging from User Management
            if (complaintGroup) complaintGroup.style.display = 'none';
            
            // Set the recipient type based on user role
            if (userRole === 'official') {
                recipientTypeSelect.value = 'official';
                
                // Load officials and select the specific one
                fetch('/admin/users')
                    .then(response => response.json())
                    .then(users => {
                        const officials = users.filter(u => u.role === 'official');
                        recipientSelect.innerHTML = '<option value="">-- Choose a recipient --</option>';
                        officials.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.email;  // Use email as value for backend compatibility
                            option.textContent = `${user.name} (${user.email})`;
                            if (user.email === userEmail) {
                                option.selected = true;
                            }
                            recipientSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading officials:', error);
                    });
            } else {
                recipientTypeSelect.value = 'resident';
                
                // Load residents and select the specific one
                fetch('/admin/users')
                    .then(response => response.json())
                    .then(users => {
                        const residents = users.filter(u => u.role === 'resident');
                        recipientSelect.innerHTML = '<option value="">-- Choose a recipient --</option>';
                        residents.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.email;  // Use email as value for backend compatibility
                            option.textContent = `${user.name} (${user.email})`;
                            if (user.email === userEmail) {
                                option.selected = true;
                            }
                            recipientSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading residents:', error);
                    });
            }
            
            // Clear and focus on subject
            document.getElementById('message-subject').value = '';
            document.getElementById('message-content').value = '';
            document.getElementById('message-subject').focus();
        }

        // Toggle block/unblock user
        function toggleBlockUser(userId, userName, isCurrentlyBlocked) {
            const action = isCurrentlyBlocked ? 'unblock' : 'block';
            const actionText = isCurrentlyBlocked ? 'unblock' : 'block';
            
            if (!confirm(`Are you sure you want to ${actionText} user: ${userName}?`)) {
                return;
            }

            fetch('/admin/user/toggle-block', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    uid: userId,
                    action: action 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadUsers();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error toggling user block status');
            });
        }
        
        // Load feedback
        async function loadFeedback(filterType = 'all') {
            try {
                const response = await fetch('/feedback/recent', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });

                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                let feedbackList = await response.json();
                const feedbackContainer = document.getElementById('feedback-list');
                
                if (!feedbackContainer) return;

                // Apply filter
                if (filterType !== 'all') {
                    if (filterType === 'positive') {
                        feedbackList = feedbackList.filter(f => f.rating >= 4);
                    } else if (filterType === 'neutral') {
                        feedbackList = feedbackList.filter(f => f.rating === 3);
                    } else if (filterType === 'negative') {
                        feedbackList = feedbackList.filter(f => f.rating <= 2);
                    }
                }

                feedbackContainer.innerHTML = '';

                if (feedbackList.length === 0) {
                    feedbackContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No feedback available</p>';
                } else {
                    feedbackList.forEach(feedback => {
                        const feedbackCard = createFeedbackCard(feedback);
                        feedbackContainer.appendChild(feedbackCard);
                    });
                }

            } catch (error) {
                console.error('Error loading feedback:', error);
                const feedbackContainer = document.getElementById('feedback-list');
                if (feedbackContainer) {
                    feedbackContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading feedback</p>';
                }
            }
        }

        // Create feedback card element
        function createFeedbackCard(feedback) {
            const card = document.createElement('div');
            
            // Determine card class based on rating
            let cardClass = 'neutral';
            let cardColor = '#f0f0f0';
            if (feedback.rating >= 4) {
                cardClass = 'positive';
                cardColor = '#e8f5e9';
            } else if (feedback.rating <= 2) {
                cardClass = 'negative';
                cardColor = '#ffebee';
            }
            
            card.style.cssText = `background: ${cardColor}; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);`;
            
            // Generate star rating HTML
            const starsHTML = generateStars(feedback.rating);
            
            // Format date
            const feedbackDate = new Date(feedback.submitted_date).toLocaleDateString();
            
            // Get feedback type display name
            const feedbackTypeDisplay = getFeedbackTypeDisplay(feedback.feedback_type);
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-circle" style="font-size: 32px; color: #0466c8;"></i>
                        <div>
                            <h4 style="margin: 0; color: #333;">${feedback.user_name || 'Anonymous'}</h4>
                            <div style="color: #ffc107; font-size: 14px; margin-top: 4px;">
                                ${starsHTML}
                            </div>
                        </div>
                    </div>
                    <span style="color: #999; font-size: 12px;">${feedbackDate}</span>
                </div>
                <div>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>Type:</strong> ${feedbackTypeDisplay}</p>
                    <p style="margin: 10px 0; color: #555; line-height: 1.5;">${feedback.message}</p>
                    ${feedback.complaint_id ? `<span style="display: inline-block; background: #0466c8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px;">${feedback.complaint_id}</span>` : ''}
                </div>
            `;
            
            return card;
        }

        // Generate star rating HTML
        function generateStars(rating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHTML += '<i class="fas fa-star"></i>';
                } else {
                    starsHTML += '<i class="far fa-star"></i>';
                }
            }
            return starsHTML;
        }

        // Get feedback type display name
        function getFeedbackTypeDisplay(type) {
            const types = {
                'complaint-process': 'Complaint Process',
                'response-time': 'Response Time',
                'staff-courtesy': 'Staff Courtesy',
                'resolution-quality': 'Resolution Quality',
                'system-usability': 'System Usability',
                'other': 'Other'
            };
            return types[type] || type;
        }

        // Feedback filter change handler
        const feedbackFilter = document.getElementById('feedback-filter');
        if (feedbackFilter) {
            feedbackFilter.addEventListener('change', function(e) {
                const filterType = e.target.value;
                loadFeedback(filterType);
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/messaging.js') }}"></script>
    <script>
        // Override loadResidentsForMessaging to filter out current user (just in case)
        const originalLoadResidents = loadResidentsForMessaging;
        loadResidentsForMessaging = function() {
            fetch('/residents/list', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(residents => {
                const select = document.getElementById('message-recipient-official') || 
                              document.getElementById('message-recipient');
                if (!select) return;

                while (select.options.length > 1) {
                    select.remove(1);
                }

                residents.forEach(resident => {
                    // Skip if this is the current user (shouldn't happen for residents, but just in case)
                    if (resident.email === currentUserEmail) {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = resident.email;
                    option.textContent = `${resident.name} (${resident.email})`;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading residents:', error));
        };
    </script>
</body>
</html>